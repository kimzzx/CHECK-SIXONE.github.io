<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#14532d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>SIXONE CHECK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  
  <style>
    body { font-family: 'LINE Seed Sans TH', sans-serif; background: #f5f5f5; }
    .btn-tappable { min-height: 44px; min-width: 44px; }
    .safe-pad { padding-top: max(1rem, env(safe-area-inset-top)); padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
    .surface { background: white; border-radius: 0.75rem; }
  </style>
</head>

<body class="safe-pad">
  <div class="max-w-4xl mx-auto px-4 py-6">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold text-green-700 mb-3 sm:mb-0">SIXONE CHECK</h1>
      <button id="addStudentBtn" class="btn-tappable bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
        + เพิ่มนักเรียน
      </button>
    </header>

    <main>
      <div id="studentList" class="space-y-3"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="surface p-6 w-[90%] max-w-md">
      <h2 class="text-lg font-semibold mb-4">เพิ่มนักเรียน</h2>
      <input id="studentNumber" placeholder="เลขที่" class="w-full border rounded px-3 py-2 mb-2" />
      <input id="studentName" placeholder="ชื่อ-สกุล" class="w-full border rounded px-3 py-2 mb-2" />
      <input id="studentClass" placeholder="ห้อง" class="w-full border rounded px-3 py-2 mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded">ยกเลิก</button>
        <button onclick="addStudent()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">บันทึก</button>
      </div>
    </div>
  </div>

<script>
/* ====== Supabase dataSdk: drop-in replacement (UI เดิมใช้ได้ทันที) ====== */
const SUPABASE_URL = "https://jxqzfslzevkgveahciwy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4cXpmc2x6ZXZrZ3ZlYWhjaXd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjIyNzcsImV4cCI6MjA3ODUzODI3N30._YTzK6DczLqbpRrMv1TS22L0Wk8BrDFa-59QEUlThcQ";

/* elementSdk (ธีม/คอนฟิก) ให้คงไว้แบบง่าย ๆ เพื่อไม่ทำลาย UI เดิม */
if (!window.elementSdk) {
  window.elementSdk = {
    config: null, _onChange: null,
    init({ defaultConfig, onConfigChange }) {
      this.config = { ...defaultConfig };
      this._onChange = onConfigChange;
      onConfigChange(this.config);
    },
    setConfig(patch) {
      this.config = { ...(this.config || {}), ...patch };
      this._onChange && this._onChange(this.config);
    }
  };
}

(function () {
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ดึงข้อมูลจาก 2 ตาราง แล้วแปลงเป็นอาร์เรย์เดียวในฟอร์แมตเดิมของแอป
  async function fetchAll() {
    const [att, stu] = await Promise.all([
      supabase.from('attendance').select('*').order('timestamp', { ascending: true }),
      supabase.from('students').select('*').order('student_number', { ascending: true })
    ]);
    if (att.error) throw att.error;
    if (stu.error) throw stu.error;

    // ให้ attendance มี __backendId = id(UUID), students มี __backendId = student_id
    const attendanceRecords = (att.data || []).map(r => ({ ...r, __backendId: r.id }));
    const studentRecords    = (stu.data || []).map(r => ({ ...r, __backendId: r.student_id }));

    // สำคัญ: ชื่อฟิลด์ฝั่ง UI ของคุณ
    // - records ที่เป็น attendance ต้อง "มี field: date"
    // - records ที่เป็น students ต้อง "มี field: student_number"
    return [...attendanceRecords, ...studentRecords];
  }

  // subscribe realtime (เปลี่ยนฝั่ง DB จะรีเฟรช UI)
  function subscribeRealtime(handler) {
    return supabase.channel('realtime:all')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => refresh(handler))
      .on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, () => refresh(handler))
      .subscribe();
  }

  async function refresh(handler) {
    try {
      const all = await fetchAll();
      handler?.onDataChanged?.(all);
    } catch (e) { console.error(e); }
  }

  // ====== dataSdk API ให้เหมือนของเดิม ======
  window.dataSdk = {
    async init(handler) {
      try {
        const all = await fetchAll();
        handler?.onDataChanged?.(all);
        this._handler = handler;
        this._channel = subscribeRealtime(handler); // live sync
        return { isOk: true };
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    },

    // create(): รับได้ทั้ง attendance & students (ตาม shape เดิมของแอป)
    async create(obj) {
      try {
        if (obj.date) {
          // ===== attendance =====
          // ควรมี unique index (date, student_id) แล้ว (คุณตั้งไว้แล้วในขั้น SQL ที่ 4)
          const payload = {
            date: obj.date,                 // 'YYYY-MM-DD'
            student_id: obj.student_id,     // string (เลขที่/ID)
            status: obj.status,             // 'มา' | 'ขาด' | 'ลา'
            remark: obj.remark || '',
            timestamp: obj.timestamp || Date.now()
          };
          const { error } = await supabase.from('attendance').insert(payload);
          if (error) throw error;
        } else if (obj.student_number) {
          // ===== students =====
          const payload = {
            student_id: obj.student_id || obj.student_number, // ให้ student_id เท่ากับเลขที่ (คงพฤติกรรมเดิม)
            student_number: obj.student_number,
            student_name: obj.student_name,
            student_class: obj.student_class,
            timestamp: obj.timestamp || Date.now()
          };
          const { error } = await supabase.from('students').insert(payload);
          if (error) throw error;
        } else {
          throw new Error('unknown object shape in create()');
        }

        this._handler && refresh(this._handler);
        return { isOk: true };
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    },

    // update(): ฝั่ง UI ของคุณจะส่ง __backendId มาแล้ว
    async update(obj) {
      try {
        if (obj.date) {
          // ===== attendance =====
          // ใช้ __backendId (uuid ของแถว) ในการอัปเดต
          const id = obj.__backendId || obj.id;
          const payload = {
            date: obj.date,
            student_id: obj.student_id,
            status: obj.status,
            remark: obj.remark || '',
            timestamp: obj.timestamp || Date.now()
          };
          const { error } = await supabase.from('attendance').update(payload).eq('id', id);
          if (error) throw error;
        } else if (obj.student_number) {
          // ===== students =====
          const id = obj.__backendId || obj.student_id || obj.student_number;
          const payload = {
            student_id: id,
            student_number: obj.student_number,
            student_name: obj.student_name,
            student_class: obj.student_class,
            timestamp: obj.timestamp || Date.now()
          };
          const { error } = await supabase.from('students').update(payload).eq('student_id', id);
          if (error) throw error;
        } else {
          throw new Error('unknown object shape in update()');
        }

        this._handler && refresh(this._handler);
        return { isOk: true };
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    },

    // delete(): ลบได้ทั้ง attendance และ students
    async delete(obj) {
      try {
        if (obj.date) {
          const id = obj.__backendId || obj.id;
          const { error } = await supabase.from('attendance').delete().eq('id', id);
          if (error) throw error;
        } else if (obj.student_number) {
          const id = obj.__backendId || obj.student_id || obj.student_number;
          // FK ของคุณน่าจะตั้ง ON DELETE CASCADE แล้ว → ลบ student จะกวาด attendance ให้เอง
          const { error } = await supabase.from('students').delete().eq('student_id', id);
          if (error) throw error;
        } else {
          throw new Error('unknown object shape in delete()');
        }

        this._handler && refresh(this._handler);
        return { isOk: true };
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    }
  };
})();
</script>
</body>
</html>
