<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CHECK SIXONE - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{box-sizing:border-box;font-family:'Inter','Noto Sans Thai',sans-serif}
    *{box-sizing:border-box}
    .toast{position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;animation:slideIn .3s ease-out;max-width:90%}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .btn-status{transition:all .2s ease;position:relative}
    .btn-status:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .btn-status:active{transform:translateY(0)}
    .btn-status.active::after{content:'‚úì';position:absolute;top:-4px;right:-4px;background:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .student-row{transition:background-color .2s ease}
    .student-row:hover{background:#f9fafb}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:999;padding:20px}
    .modal-content{background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:90%;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    @media (max-width:640px){.toast{left:20px;right:20px;max-width:none}}
    @view-transition { navigation: auto; }
  </style>

  <!-- Fallback SDKs: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ /_sdk/* (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage) -->
  <script>
/* ===== Supabase dataSdk: sync ‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ===== */
// ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const SUPABASE_URL = "https://jxqzfslzevkgveahciwy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4cXpmc2x6ZXZrZ3ZlYWhjaXd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjIyNzcsImV4cCI6MjA3ODUzODI3N30._YTzK6DczLqbpRrMv1TS22L0Wk8BrDFa-59QEUlThcQ";

// elementSdk ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (‡∏ò‡∏µ‡∏°/‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡πÄ‡∏â‡∏¢ ‡πÜ)
if (!window.elementSdk) {
  window.elementSdk = {
    config: null, _onChange: null,
    init({ defaultConfig, onConfigChange }) {
      this.config = { ...defaultConfig };
      this._onChange = onConfigChange;
      onConfigChange(this.config);
    },
    setConfig(patch) {
      this.config = { ...(this.config || {}), ...patch };
      this._onChange && this._onChange(this.config);
    }
  };
}

// dataSdk ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Supabase
(function () {
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function fetchAll() {
    const [att, stu] = await Promise.all([
      supabase.from('attendance').select('*').order('timestamp', { ascending: true }),
      supabase.from('students').select('*').order('student_number', { ascending: true })
    ]);
    if (att.error) throw att.error;
    if (stu.error) throw stu.error;

    // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ
    // attendance: ‡∏°‡∏µ field date => ‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° attendanceRecords
    // students: ‡∏°‡∏µ field student_number => ‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° studentRecords
    const attendanceRecords = (att.data || []).map(r => ({ ...r, __backendId: r.id }));
    const studentRecords = (stu.data || []).map(r => ({ ...r, __backendId: r.student_id }));
    return [...attendanceRecords, ...studentRecords];
  }

  // subscribe realtime ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ñ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏ô 2 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  function subscribeRealtime(handler) {
    const channel = supabase.channel('realtime:all')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => refresh(handler))
      .on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, () => refresh(handler))
      .subscribe();
    return channel;
  }

  async function refresh(handler) {
    try {
      const all = await fetchAll();
      handler?.onDataChanged?.(all);
    } catch (e) {
      console.error(e);
    }
  }

  window.dataSdk = {
    async init(handler) {
      try {
        const all = await fetchAll();
        handler?.onDataChanged?.(all);
        this._handler = handler;
        this._channel = subscribeRealtime(handler);
        return { isOk: true };
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    },

    // obj ‡∏Ñ‡∏∑‡∏≠ record ‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏õ‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô attendance ‡∏´‡∏£‡∏∑‡∏≠ students)
    async create(obj) {
      try {
        if (obj.date) {
          // attendance
          const payload = {
            date: obj.date,            // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô 'YYYY-MM-DD'
            student_id: obj.student_id,
            status: obj.status,
            remark: obj.remark || '',
            timestamp: obj.timestamp || Date.now()
          };
          const { data, error } = await supabase.from('attendance').insert(payload).select('*').single();
          if (error) throw error;
          this._handler && refresh(this._handler);
          return { isOk: true, data };
        } else if (obj.student_number) {
          // students
          const payload = {
            student_id: obj.student_id || obj.student_number,
            student_number: obj.student_number,
            student_name: obj.student_name,
            student_class: obj.student_class,
            timestamp: obj.timestamp || Date.now()
          };
          const { data, error } = await supabase.from('students').insert(payload).select('*').single();
          if (error) throw error;
          this._handler && refresh(this._handler);
          return { isOk: true, data };
        } else {
          throw new Error('unknown object shape');
        }
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    },

    async update(obj) {
      try {
        if (obj.date) {
          // attendance ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ __backendId (uuid)
          const id = obj.__backendId || obj.id;
          const payload = {
            date: obj.date,
            student_id: obj.student_id,
            status: obj.status,
            remark: obj.remark || '',
            timestamp: obj.timestamp || Date.now()
          };
          const { error } = await supabase.from('attendance').update(payload).eq('id', id);
          if (error) throw error;
          this._handler && refresh(this._handler);
          return { isOk: true };
        } else if (obj.student_number) {
          // students ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ __backendId = student_id
          const id = obj.__backendId || obj.student_id || obj.student_number;
          const payload = {
            student_id: id,
            student_number: obj.student_number,
            student_name: obj.student_name,
            student_class: obj.student_class,
            timestamp: obj.timestamp || Date.now()
          };
          const { error } = await supabase.from('students').update(payload).eq('student_id', id);
          if (error) throw error;
          this._handler && refresh(this._handler);
          return { isOk: true };
        } else {
          throw new Error('unknown object shape');
        }
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    },

    async delete(obj) {
      try {
        if (obj.date) {
          const id = obj.__backendId || obj.id;
          const { error } = await supabase.from('attendance').delete().eq('id', id);
          if (error) throw error;
        } else if (obj.student_number) {
          const id = obj.__backendId || obj.student_id || obj.student_number;
          // ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡∏•‡∏ö attendance ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ FK on delete cascade)
          const { error } = await supabase.from('students').delete().eq('student_id', id);
          if (error) throw error;
        } else {
          throw new Error('unknown object shape');
        }
        this._handler && refresh(this._handler);
        return { isOk: true };
      } catch (e) {
        console.error(e);
        return { isOk: false, error: e.message };
      }
    }
  };
})();
</script>
</head>

<body class="bg-gray-50">
  <div id="app"></div>

  <script>
  /* ======================= CONFIG & STATE ======================= */
  const defaultConfig = {
    background_color:'#f9fafb',
    surface_color:'#ffffff',
    text_color:'#1f2937',
    primary_color:'#14532d',
    secondary_color:'#16a34a',
    font_family:'Inter',
    font_size:16,
    app_title:'CHECK SIXONE',
    tagline:'‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
    cta_button:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
    menu_check:'‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
    menu_students:'‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    menu_report:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
    menu_settings:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
    menu_about:'‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö'
  };

  // ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á)
  const referenceStudents = [];

  let currentPage = 'home';
  let attendanceRecords = [];
  let studentRecords = [];
  let searchQuery = '';
  let filterClass = 'all';
  let isLoading = false;
  let editingStudent = null;
  let showEditModal = false;
  let showAddModal = false;
  let deletingStudentId = null;

  const dataHandler = {
    onDataChanged(data) {
      attendanceRecords = data.filter(r => r.date);
      studentRecords   = data.filter(r => r.student_number);
      render();
    }
  };

  async function initApp() {
    const ok = await window.dataSdk.init(dataHandler);
    if (!ok.isOk) { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ','error'); return; }
    render();
  }

  /* ======================= HELPERS ======================= */
  function getStudentList() {
    const customStudents = studentRecords.map(s => ({
      id:s.student_id, name:s.student_name, class:s.student_class,
      isCustom:true, recordId:s.__backendId
    }));
    const referenceStudentIds = referenceStudents.map(s => s.id);
    const merged = referenceStudents.map(ref => {
      const cs = customStudents.find(x => x.id === ref.id);
      return cs || { ...ref, isCustom:false };
    });
    customStudents.forEach(cs => {
      if (!referenceStudentIds.includes(cs.id)) merged.push(cs);
    });
    return merged.sort((a,b)=>(parseInt(a.id)||0)-(parseInt(b.id)||0));
  }

  const getTodayString = () => {
    const d=new Date(); const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };

  function getStudentStatus(studentId, date){
    const r = attendanceRecords.find(r => r.student_id===studentId && r.date===date);
    return r ? r.status : null;
  }

  async function setAttendance(studentId, status){
    if (attendanceRecords.length >= 999) { showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','error'); return; }
    isLoading = true; render();

    const today = getTodayString();
    const existing = attendanceRecords.find(r => r.student_id===studentId && r.date===today);

    if (existing){
      existing.status = status; existing.timestamp = Date.now();
      await window.dataSdk.update(existing);
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    }else{
      const rec = { date:today, student_id:studentId, status, remark:'', timestamp:Date.now() };
      await window.dataSdk.create(rec);
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    }
    isLoading=false; render();
  }

  async function markAllPresent(){
    const students = getStudentList();
    if (attendanceRecords.length + students.length > 999) {
      showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','error'); return;
    }
    isLoading=true; render();
    const today=getTodayString();

    for (const s of students){
      const ex = attendanceRecords.find(r => r.student_id===s.id && r.date===today);
      if (ex) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö (‡∏™‡∏≤‡∏¢/‡∏•‡∏≤/‡∏Ç‡∏≤‡∏î/‡∏°‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        continue;
      } else {
        await window.dataSdk.create({date:today, student_id:s.id, status:'‡∏°‡∏≤', remark:'', timestamp:Date.now()});
      }
    isLoading=false; showToast('‡∏ï‡∏¥‡πä‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'); render();
  }

function getTodaySummary(){
  const today = getTodayString();
  const recs = attendanceRecords.filter(r=>r.date===today);
  const total = getStudentList().length;
  return {
    present: recs.filter(r=>r.status==='‡∏°‡∏≤').length,
    absent:  recs.filter(r=>r.status==='‡∏Ç‡∏≤‡∏î').length,
    leave:   recs.filter(r=>r.status==='‡∏•‡∏≤').length,
    late:    recs.filter(r=>r.status==='‡∏™‡∏≤‡∏¢').length,
    total
  };
}

  function showToast(msg,type='success'){
    const old=document.querySelector('.toast'); if (old) old.remove();
    const el=document.createElement('div');
    el.className=`toast ${type==='success'?'bg-green-600':'bg-red-600'} text-white`;
    el.textContent=msg; document.body.appendChild(el);
    setTimeout(()=>el.remove(),3000);
  }

  function generateSummaryText(){
  const today=getTodayString();
  const recs=attendanceRecords.filter(r=>r.date===today);
  const students=getStudentList(); const s=getTodaySummary();

  const thaiDate=new Date(today).toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
  let text=`üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate}\n‡∏´‡πâ‡∏≠‡∏á: 6/1\n\n`;
  text+=`‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:\n`;
  text+=`‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.present} ‡∏Ñ‡∏ô\n`;
  text+=`‚è∞ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢: ${s.late} ‡∏Ñ‡∏ô\n`;
  text+=`‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.absent} ‡∏Ñ‡∏ô\n`;
  text+=`üìù ‡∏•‡∏≤: ${s.leave} ‡∏Ñ‡∏ô\n`;
  text+=`üë• ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${s.total} ‡∏Ñ‡∏ô\n\n`;

  if (s.late>0){
    text+=`‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢:\n`;
    students.forEach(st=>{
      const r=recs.find(x=>x.student_id===st.id);
      if (r && r.status==='‡∏™‡∏≤‡∏¢') text+=`  - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${st.id} ${st.name}\n`;
    });
    text+=`\n`;
  }

  if (s.absent>0){
    text+=`‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:\n`;
    students.forEach(st=>{
      const r=recs.find(x=>x.student_id===st.id);
      if (r && r.status==='‡∏Ç‡∏≤‡∏î') text+=`  - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${st.id} ${st.name}\n`;
    });
    text+=`\n`;
  }

  if (s.leave>0){
    text+=`‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤:\n`;
    students.forEach(st=>{
      const r=recs.find(x=>x.student_id===st.id);
      if (r && r.status==='‡∏•‡∏≤') text+=`  - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${st.id} ${st.name}\n`;
    });
    text+=`\n`;
  }

  text+=`---\n‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ CHECK SIXONE`;
  return text;
}

  function copySummary(){
    const t=generateSummaryText();
    (navigator.clipboard?.writeText?.(t) ?? Promise.reject()).then(
      ()=>showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'),
      ()=>{ // fallback
        const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'); }catch{ showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
        document.body.removeChild(ta);
      }
    );
  }

  function exportCSV(){
    const today=getTodayString();
    const recs=attendanceRecords.filter(r=>r.date===today);
    if (!recs.length){ showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ','error'); return; }
    const students=getStudentList();
    let csv='‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏\n';
    students.forEach(s=>{
      const r=recs.find(x=>x.student_id===s.id);
      csv+=`${today},${s.id},${s.name},${s.class},${r? r.status : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ'},${r? r.remark:''}\n`;
    });
    const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob);
    link.download=`‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠_${today}.csv`; document.body.appendChild(link); link.click();
    document.body.removeChild(link); URL.revokeObjectURL(link.href);
    showToast(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${recs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,'success');
  }

  function getFilteredStudents(){
    return getStudentList().filter(s=>{
      const matchesSearch = (s.name||'').toLowerCase().includes((searchQuery||'').toLowerCase()) || (s.id||'').includes(searchQuery||'');
      const matchesClass = filterClass==='all' || s.class===filterClass;
      return matchesSearch && matchesClass;
    });
  }

  function openEditModal(id){ const st=getStudentList().find(s=>s.id===id); if(st){ editingStudent={...st}; showEditModal=true; render(); } }
  function closeEditModal(){ editingStudent=null; showEditModal=false; render(); }
  function openAddModal(){ showAddModal=true; render(); }
  function closeAddModal(){ showAddModal=false; render(); }
  function confirmDeleteStudent(id, recordId){ deletingStudentId={id,recordId}; render(); }
  function cancelDelete(){ deletingStudentId=null; render(); }

  async function deleteStudent(){
    if (!deletingStudentId) return;
    isLoading=true; render();
    const record = studentRecords.find(r=>r.student_id===deletingStudentId.id);
    if (record?.__backendId){ await window.dataSdk.delete(record); showToast('‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'); }
    else { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÑ‡∏î‡πâ','error'); }
    deletingStudentId=null; isLoading=false; render();
  }

  async function saveStudent(e){
    e.preventDefault();
    if (studentRecords.length>=999 && !editingStudent.isCustom){ showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','error'); return; }
    isLoading=true; render();
    const f=new FormData(e.target);
    const newNumber=f.get('student_number'); const newName=f.get('student_name'); const newClass=f.get('student_class');

    const dup=getStudentList().find(s=>s.id===newNumber && s.id!==editingStudent.id);
    if (dup){ showToast('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß','error'); isLoading=false; render(); return; }

    if (editingStudent.isCustom && editingStudent.recordId){
      const ex=studentRecords.find(r=>r.__backendId===editingStudent.recordId);
      if (ex){ ex.student_id=newNumber; ex.student_number=newNumber; ex.student_name=newName; ex.student_class=newClass; ex.timestamp=Date.now(); await window.dataSdk.update(ex); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'); }
    } else {
      await window.dataSdk.create({ student_id:newNumber, student_number:newNumber, student_name:newName, student_class:newClass, timestamp:Date.now() });
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    }
    closeEditModal(); isLoading=false; render();
  }

  async function addNewStudent(e){
    e.preventDefault();
    if (studentRecords.length>=999){ showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','error'); return; }
    isLoading=true; render();
    const f=new FormData(e.target);
    const newNumber=f.get('student_number'); const newName=f.get('student_name'); const newClass=f.get('student_class');
    if (getStudentList().find(s=>s.id===newNumber)){ showToast('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß','error'); isLoading=false; render(); return; }
    await window.dataSdk.create({ student_id:newNumber, student_number:newNumber, student_name:newName, student_class:newClass, timestamp:Date.now() });
    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'); closeAddModal(); isLoading=false; render();
  }

  /* ======================= RENDERERS ======================= */
  function render(){ 
    const config = window.elementSdk?.config || defaultConfig;
    const app = document.getElementById('app');

    if (currentPage==='home')      app.innerHTML = renderHomePage(config);
    else if (currentPage==='check')app.innerHTML = renderCheckPage(config);
    else if (currentPage==='students') app.innerHTML = renderStudentsPage(config);
    else if (currentPage==='report')   app.innerHTML = renderReportPage(config);
    else if (currentPage==='settings') app.innerHTML = renderSettingsPage(config);
    else if (currentPage==='about')    app.innerHTML = renderAboutPage(config);

    if (showEditModal) app.innerHTML += renderEditModal(config);
    if (showAddModal)  app.innerHTML += renderAddModal(config);
    if (deletingStudentId) app.innerHTML += renderDeleteConfirmation(config);

    attachEventListeners(); onConfigChange(config);
  }

  function renderEditModal(config){
    if (!editingStudent) return '';
    return `
    <div class="modal-overlay" onclick="handleEditModalClick(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-content" style="color:${config.text_color}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <button onclick="closeEditModal()" class="text-2xl hover:opacity-70" style="color:${config.text_color}">&times;</button>
          </div>
          <form onsubmit="saveStudent(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color:${config.text_color}">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
              <input type="text" name="student_number" value="${editingStudent.id}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color:${config.text_color}">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
              <input type="text" name="student_name" value="${editingStudent.name}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color:${config.text_color}">‡∏´‡πâ‡∏≠‡∏á</label>
              <input type="text" name="student_class" value="${editingStudent.class}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}"/>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 px-6 py-3 rounded-lg text-white font-medium" style="background:${config.primary_color}" ${isLoading?'disabled':''}>${isLoading?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}</button>
              <button type="button" onclick="closeEditModal()" class="flex-1 px-6 py-3 rounded-lg font-medium border" style="border-color:${config.primary_color};color:${config.primary_color}" ${isLoading?'disabled':''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </form>
        </div>
      </div>
    </div>`;
  }

  function renderAddModal(config){
    return `
    <div class="modal-overlay" onclick="handleAddModalClick(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold" style="color:${config.text_color}">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <button onclick="closeAddModal()" class="text-2xl hover:opacity-70" style="color:${config.text_color}">&times;</button>
          </div>
          <form onsubmit="addNewStudent(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color:${config.text_color}">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
              <input type="text" name="student_number" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 11" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color:${config.text_color}">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
              <input type="text" name="student_name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î.‡∏ä. ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color:${config.text_color}">‡∏´‡πâ‡∏≠‡∏á</label>
              <input type="text" name="student_class" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 6/1" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}"/>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 px-6 py-3 rounded-lg text-white font-medium" style="background:${config.primary_color}" ${isLoading?'disabled':''}>${isLoading?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...':'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'}</button>
              <button type="button" onclick="closeAddModal()" class="flex-1 px-6 py-3 rounded-lg font-medium border" style="border-color:${config.primary_color};color:${config.primary_color}" ${isLoading?'disabled':''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </form>
        </div>
      </div>
    </div>`;
  }

  function renderDeleteConfirmation(config){
    const students=getStudentList();
    const st=students.find(s=>s.id===deletingStudentId.id);
    return `
    <div class="modal-overlay" onclick="event.stopPropagation()">
      <div class="modal-content" style="max-width:400px" onclick="event.stopPropagation()">
        <div class="p-6 text-center">
          <div class="text-5xl mb-4">‚ö†Ô∏è</div>
          <h3 class="text-xl font-bold mb-2" style="color:${config.text_color}">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="text-sm" style="color:${config.text_color};opacity:.7">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô<br/><strong>${st?st.name:''}</strong><br/>‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-3 mt-6">
            <button onclick="deleteStudent()" class="flex-1 px-6 py-3 rounded-lg text-white font-medium bg-red-600 hover:bg-red-700" ${isLoading?'disabled':''}>${isLoading?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...':'‡∏•‡∏ö'}</button>
            <button onclick="cancelDelete()" class="flex-1 px-6 py-3 rounded-lg font-medium border" style="border-color:${config.primary_color};color:${config.primary_color}" ${isLoading?'disabled':''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>
      </div>
    </div>`;
  }

  function renderHomePage(config){
    const s=getTodaySummary();
    return `
    <div class="min-h-full" style="background:${config.background_color}">
      ${renderHeader(config)}
      <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h1 id="app-title" class="text-4xl font-bold mb-4" style="color:${config.primary_color}">${config.app_title}</h1>
          <p id="tagline" class="text-xl" style="color:${config.text_color}">${config.tagline}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="p-6 rounded-lg shadow-md surface" style="background:${config.surface_color}">
            <div class="flex items-center justify-between">
              <div><p class="text-sm" style="color:${config.text_color};opacity:.7">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p><p class="text-3xl font-bold" style="color:${config.secondary_color}">${s.present}</p></div>
              <div class="text-4xl">‚úì</div>
            </div>
          </div>
          <div class="p-6 rounded-lg shadow-md surface" style="background:${config.surface_color}">
            <div class="flex items-center justify-between">
              <div><p class="text-sm" style="color:${config.text_color};opacity:.7">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p><p class="text-3xl font-bold text-red-600">${s.absent}</p></div>
              <div class="text-4xl">‚úó</div>
            </div>
          </div>
          <div class="p-6 rounded-lg shadow-md surface" style="background:${config.surface_color}">
            <div class="flex items-center justify-between">
              <div><p class="text-sm" style="color:${config.text_color};opacity:.7">‡∏•‡∏≤</p><p class="text-3xl font-bold text-yellow-600">${s.leave}</p></div>
              <div class="text-4xl">üìù</div>
            </div>
          </div>
        </div>

        <div class="text-center">
          <button id="cta-button" class="px-8 py-4 rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transition-all" style="background:${config.primary_color}" onclick="navigateTo('check')">${config.cta_button}</button>
        </div>
      </main>
    </div>`;
  }

  function renderCheckPage(config){
    const today=getTodayString(); const s=getTodaySummary(); const list=getFilteredStudents();
    return `
    <div class="min-h-full" style="background:${config.background_color}">
      ${renderHeader(config)}
      <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold mb-2" style="color:${config.text_color}">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
          <p style="color:${config.text_color};opacity:.7">${today}</p>
        </div>

        <div class="p-4 rounded-lg shadow-md mb-6 surface" style="background:${config.surface_color}">
          <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex gap-4 text-sm">
              <span>‡∏°‡∏≤: <strong style="color:${config.secondary_color}">${s.present}</strong></span>
              <span>‡∏™‡∏≤‡∏¢: <strong class="text-orange-500">${s.late}</strong></span>
              <span>‡∏Ç‡∏≤‡∏î: <strong class="text-red-600">${s.absent}</strong></span>
              <span>‡∏•‡∏≤: <strong class="text-yellow-600">${s.leave}</strong></span>
            </div>
            <button class="px-4 py-2 rounded-lg text-white font-medium text-sm" style="background:${config.secondary_color}" onclick="markAllPresent()" ${isLoading?'disabled':''}>${isLoading?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...':'‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á'}</button>
          </div>
        </div>

        <div class="p-4 rounded-lg shadow-md mb-6 surface" style="background:${config.surface_color}">
          <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà..." class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}" value="${searchQuery}" oninput="handleSearch(event)"/>
            <select class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color:${config.primary_color};color:${config.text_color}" onchange="handleFilterChange(event)">
              <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
              <option value="6/1" ${filterClass==='6/1'?'selected':''}>6/1</option>
              <option value="6/2" ${filterClass==='6/2'?'selected':''}>6/2</option>
            </select>
          </div>
        </div>

        <div class="rounded-lg shadow-md overflow-hidden surface" style="background:${config.surface_color}">
          ${list.map(st=>{
            const status=getStudentStatus(st.id,today);
            return `
              <div class="student-row p-4 border-b last:border-b-0" style="border-color:rgba(0,0,0,.1)">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3">
                      <span class="font-bold text-lg" style="color:${config.primary_color}">${st.id}</span>
                      <h3 class="font-semibold" style="color:${config.text_color}">${st.name || '-'}</h3>
                    </div>
                    <p class="text-sm" style="color:${config.text_color};opacity:.6">${st.class || '-'}</p>
                  </div>
                  <div class="flex gap-2">
                  <button class="btn-status ${status==='‡∏°‡∏≤'?'active':''} px-4 py-2 rounded-lg font-medium text-sm text-white"
                    style="background:${status==='‡∏°‡∏≤'?config.secondary_color:'#9ca3af'}"
                    onclick="setAttendance('${st.id}','‡∏°‡∏≤')" ${isLoading?'disabled':''}>‡∏°‡∏≤</button>
                
                  <button class="btn-status ${status==='‡∏™‡∏≤‡∏¢'?'active':''} px-4 py-2 rounded-lg font-medium text-sm text-white"
                    style="background:${status==='‡∏™‡∏≤‡∏¢'?'#f97316':'#9ca3af'}"
                    onclick="setAttendance('${st.id}','‡∏™‡∏≤‡∏¢')" ${isLoading?'disabled':''}>‡∏™‡∏≤‡∏¢</button>
                
                  <button class="btn-status ${status==='‡∏Ç‡∏≤‡∏î'?'active':''} px-4 py-2 rounded-lg font-medium text-sm text-white"
                    style="background:${status==='‡∏Ç‡∏≤‡∏î'?'#dc2626':'#9ca3af'}"
                    onclick="setAttendance('${st.id}','‡∏Ç‡∏≤‡∏î')" ${isLoading?'disabled':''}>‡∏Ç‡∏≤‡∏î</button>
                
                  <button class="btn-status ${status==='‡∏•‡∏≤'?'active':''} px-4 py-2 rounded-lg font-medium text-sm text-white"
                    style="background:${status==='‡∏•‡∏≤'?'#ca8a04':'#9ca3af'}"
                    onclick="setAttendance('${st.id}','‡∏•‡∏≤')" ${isLoading?'disabled':''}>‡∏•‡∏≤</button>
                </div>
              </div>`;
          }).join('')}
        </div>
      </main>
    </div>`;
  }

  function renderStudentsPage(config){
    const students=getStudentList();
    return `
    <div class="min-h-full" style="background:${config.background_color}">
      ${renderHeader(config)}
      <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold" style="color:${config.text_color}">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
          <button onclick="openAddModal()" class="px-6 py-2 rounded-lg text-white font-medium" style="background:${config.primary_color}">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>

        <div class="rounded-lg shadow-md overflow-hidden surface" style="background:${config.surface_color}">
          <table class="w-full">
            <thead style="background:${config.primary_color}">
              <tr>
                <th class="px-6 py-3 text-left text-sm font-semibold text-white">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-white">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                <th class="px-6 py-3 text-left text-sm font-semibold text-white">‡∏´‡πâ‡∏≠‡∏á</th>
                <th class="px-6 py-3 text-center text-sm font-semibold text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              ${students.map(st=>`
                <tr class="border-b hover:bg-gray-50" style="border-color:rgba(0,0,0,.1)">
                  <td class="px-6 py-4 text-sm font-medium" style="color:${config.text_color}">${st.id}</td>
                  <td class="px-6 py-4 text-sm" style="color:${config.text_color}">${st.name}</td>
                  <td class="px-6 py-4 text-sm" style="color:${config.text_color}">${st.class}</td>
                  <td class="px-6 py-4 text-center">
                    <div class="flex gap-2 justify-center">
                      <button onclick="openEditModal('${st.id}')" class="px-4 py-2 rounded text-white text-sm font-medium hover:opacity-90" style="background:${config.secondary_color}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                      <button onclick="confirmDeleteStudent('${st.id}','${st.recordId||''}')" class="px-4 py-2 rounded text-white text-sm font-medium hover:opacity-90 bg-red-600">‡∏•‡∏ö</button>
                    </div>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>

        <div class="mt-6 text-center text-sm" style="color:${config.text_color}">
          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${students.length}</strong> ‡∏Ñ‡∏ô
        </div>
      </main>
    </div>`;
  }

  function renderReportPage(config){
    const s=getTodaySummary();
    return `
    <div class="min-h-full" style="background:${config.background_color}">
      ${renderHeader(config)}
      <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold mb-6" style="color:${config.text_color}">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="p-6 rounded-lg shadow-md surface" style="background:${config.surface_color}">
            <h3 class="text-lg font-semibold mb-4" style="color:${config.text_color}">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span><span class="font-bold" style="color:${config.secondary_color}">${s.present}</span></div>
              <div class="flex justify-between"><span>‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span><span class="font-bold text-red-600">${s.absent}</span></div>
              <div class="flex justify-between"><span>‡∏•‡∏≤</span><span class="font-bold text-yellow-600">${s.leave}</span></div>
              <div class="flex justify-between pt-2 border-t" style="border-color:rgba(0,0,0,.1)"><span class="font-semibold">‡∏£‡∏ß‡∏°</span><span class="font-bold">${s.total}</span></div>
            </div>
          </div>

          <div class="p-6 rounded-lg shadow-md md:col-span-2 surface" style="background:${config.surface_color}">
            <h3 class="text-lg font-semibold mb-4" style="color:${config.text_color}">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
            <div class="flex items-end justify-around h-48 gap-2">
              ${[1,2,3,4,5].map(day=>{
                const h=Math.random()*80+20;
                return `<div class="flex-1 flex flex-col items-center gap-2"><div class="w-full rounded-t" style="background:${config.secondary_color};height:${h}%"></div><span class="text-xs">‡∏ß‡∏±‡∏ô ${day}</span></div>`;
              }).join('')}
            </div>
          </div>
        </div>

        <div class="p-6 rounded-lg shadow-md mb-6 surface" style="background:${config.surface_color}">
          <h3 class="text-lg font-semibold mb-4" style="color:${config.text_color}">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
          <div class="p-4 rounded mb-4" style="background:${config.background_color}">
            <pre class="text-sm whitespace-pre-wrap" style="color:${config.text_color}">${generateSummaryText()}</pre>
          </div>
          <button class="px-6 py-3 rounded-lg text-white font-medium" style="background:${config.secondary_color}" onclick="copySummary()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</button>
        </div>

        <div class="p-6 rounded-lg shadow-md surface" style="background:${config.surface_color}">
          <h3 class="text-lg font-semibold mb-4" style="color:${config.text_color}">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
          <p class="text-sm mb-4" style="color:${config.text_color};opacity:.7">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV</p>
          <button class="px-6 py-3 rounded-lg text-white font-medium" style="background:${config.primary_color}" onclick="exportCSV()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
        </div>
      </main>
    </div>`;
  }

  function renderSettingsPage(config){
    const students=getStudentList();
    return `
    <div class="min-h-full" style="background:${config.background_color}">
      ${renderHeader(config)}
      <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold mb-6" style="color:${config.text_color}">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>

        <div class="p-6 rounded-lg shadow-md mb-6 surface" style="background:${config.surface_color}">
          <h3 class="text-lg font-semibold mb-4">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
          <div class="flex items-center gap-2 p-3 rounded" style="background:${config.background_color}">
            <span class="text-2xl">üíæ</span>
            <span class="text-sm font-medium" style="color:${config.secondary_color}">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (localStorage)</span>
          </div>
        </div>

        <div class="p-6 rounded-lg shadow-md surface" style="background:${config.surface_color}">
          <h3 class="text-lg font-semibold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between"><span style="opacity:.7">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>${attendanceRecords.length + studentRecords.length} / 999</span></div>
            <div class="flex justify-between"><span style="opacity:.7">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span><span>${students.length} ‡∏Ñ‡∏ô</span></div>
            <div class="flex justify-between"><span style="opacity:.7">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô</span><span>1.1.0</span></div>
          </div>
        </div>
      </main>
    </div>`;
  }

  function renderAboutPage(config){
    return `
    <div class="min-h-full" style="background:${config.background_color}">
      ${renderHeader(config)}
      <main class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold mb-6" style="color:${config.text_color}">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <div class="p-6 rounded-lg shadow-md mb-6 surface" style="background:${config.surface_color}">
          <h3 class="text-lg font-semibold mb-4">CHECK SIXONE</h3>
          <p class="mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô ‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ</p>
          <div class="space-y-1 text-sm">
            <p>‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡πä‡∏Å‡∏á‡πà‡∏≤‡∏¢‡πÜ</p>
            <p>‚úì ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ</p>
            <p>‚úì ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
            <p>‚úì ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV</p>
            <p>‚úì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage</p>
          </div>
        </div>
      </main>
    </div>`;
  }

  function renderHeader(config){
    return `
    <header class="shadow-sm surface" style="background:${config.surface_color}">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="font-bold text-xl" style="color:${config.primary_color}">CS6/1</div>
          <div class="flex gap-1 sm:gap-4 text-sm">
            <button id="menu-check" class="px-2 sm:px-4 py-2 rounded hover:bg-gray-100 ${currentPage==='check'?'font-semibold':''}" style="color:${currentPage==='check'?config.primary_color:config.text_color}" onclick="navigateTo('check')">${config.menu_check}</button>
            <button id="menu-students" class="px-2 sm:px-4 py-2 rounded hover:bg-gray-100 ${currentPage==='students'?'font-semibold':''}" style="color:${currentPage==='students'?config.primary_color:config.text_color}" onclick="navigateTo('students')">${config.menu_students}</button>
            <button id="menu-report" class="px-2 sm:px-4 py-2 rounded hover:bg-gray-100 ${currentPage==='report'?'font-semibold':''}" style="color:${currentPage==='report'?config.primary_color:config.text_color}" onclick="navigateTo('report')">${config.menu_report}</button>
            <button id="menu-settings" class="px-2 sm:px-4 py-2 rounded hover:bg-gray-100 ${currentPage==='settings'?'font-semibold':''}" style="color:${currentPage==='settings'?config.primary_color:config.text_color}" onclick="navigateTo('settings')">${config.menu_settings}</button>
            <button id="menu-about" class="px-2 sm:px-4 py-2 rounded hover:bg-gray-100 ${currentPage==='about'?'font-semibold':''}" style="color:${currentPage==='about'?config.primary_color:config.text_color}" onclick="navigateTo('about')">${config.menu_about}</button>
          </div>
        </div>
      </nav>
    </header>`;
  }

  function attachEventListeners(){
    window.navigateTo = (p)=>{ currentPage=p; render(); };
    window.setAttendance=setAttendance;
    window.markAllPresent=markAllPresent;
    window.exportCSV=exportCSV;
    window.copySummary=copySummary;
    window.openEditModal=openEditModal;
    window.closeEditModal=closeEditModal;
    window.saveStudent=saveStudent;
    window.openAddModal=openAddModal;
    window.closeAddModal=closeAddModal;
    window.addNewStudent=addNewStudent;
    window.confirmDeleteStudent=confirmDeleteStudent;
    window.cancelDelete=cancelDelete;
    window.deleteStudent=deleteStudent;

    window.handleSearch=(e)=>{ searchQuery=e.target.value; render(); };
    window.handleFilterChange=(e)=>{ filterClass=e.target.value; render(); };
    window.handleEditModalClick=(e)=>{ if(e.target.classList.contains('modal-overlay')) closeEditModal(); };
    window.handleAddModalClick=(e)=>{ if(e.target.classList.contains('modal-overlay')) closeAddModal(); };
  }

  function onConfigChange(config){
    const customFont=config.font_family || defaultConfig.font_family;
    const baseSize=config.font_size || defaultConfig.font_size;
    document.body.style.fontFamily=`${customFont}, Inter, Noto Sans Thai, sans-serif`;
    document.body.style.backgroundColor=config.background_color;
    document.body.style.color=config.text_color;

    const appTitle=document.getElementById('app-title');
    if (appTitle){ appTitle.style.fontSize=`${baseSize*1.5}px`; appTitle.style.color=config.primary_color; }
    const tagline=document.getElementById('tagline');
    if (tagline){ tagline.style.fontSize=`${baseSize}px`; tagline.style.color=config.text_color; }
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  window.elementSdk.init({
    defaultConfig,
    onConfigChange,
    mapToCapabilities: ()=>({}) // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  });
  initApp();
  </script>
</body>
</html>
