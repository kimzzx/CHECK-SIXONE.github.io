<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#14532d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>SIXONE CHECK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'LINE Seed Sans TH', sans-serif; background: #f5f5f5; }
    .btn-tappable { min-height: 44px; min-width: 44px; }
    .safe-pad { padding-top: max(1rem, env(safe-area-inset-top)); padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
    .surface { background: white; border-radius: 0.75rem; }
  </style>
</head>

<body class="safe-pad">
  <div class="max-w-4xl mx-auto px-4 py-6">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold text-green-700 mb-3 sm:mb-0">SIXONE CHECK</h1>
      <button id="addStudentBtn" class="btn-tappable bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
        + เพิ่มนักเรียน
      </button>
    </header>

    <main>
      <div id="studentList" class="space-y-3"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="surface p-6 w-[90%] max-w-md">
      <h2 class="text-lg font-semibold mb-4">เพิ่มนักเรียน</h2>
      <input id="studentNumber" placeholder="เลขที่" class="w-full border rounded px-3 py-2 mb-2" />
      <input id="studentName" placeholder="ชื่อ-สกุล" class="w-full border rounded px-3 py-2 mb-2" />
      <input id="studentClass" placeholder="ห้อง" class="w-full border rounded px-3 py-2 mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded">ยกเลิก</button>
        <button onclick="addStudent()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">บันทึก</button>
      </div>
    </div>
  </div>

  <script>
  const SUPABASE_URL = "https://jxqzfslzevkgveahciwy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4cXpmc2x6ZXZrZ3ZlYWhjaXd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjIyNzcsImV4cCI6MjA3ODUzODI3N30._YTzK6DczLqbpRrMv1TS22L0Wk8BrDFa-59QEUlThcQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const listEl = document.getElementById('studentList');
  const modal = document.getElementById('modal');
  const studentNumberEl = document.getElementById('studentNumber');
  const studentNameEl = document.getElementById('studentName');
  const studentClassEl = document.getElementById('studentClass');

  // ดึงข้อมูลนักเรียนทั้งหมด
  async function loadStudents() {
    const { data, error } = await supabase.from('students').select('*').order('student_number');
    if (error) { console.error(error); return; }
    renderStudents(data);
  }

  // แสดงข้อมูลนักเรียน
  function renderStudents(students) {
    listEl.innerHTML = students.map(st => `
      <div class="surface p-4 flex justify-between items-center">
        <div>
          <div class="font-semibold text-lg">${st.student_name}</div>
          <div class="text-sm text-gray-500">เลขที่ ${st.student_number} | ห้อง ${st.student_class}</div>
        </div>
        <div class="flex gap-2">
          <button class="btn-tappable bg-blue-500 text-white px-3 py-2 rounded" onclick="markAttendance('${st.student_id}', 'มา')">มา</button>
          <button class="btn-tappable bg-yellow-500 text-white px-3 py-2 rounded" onclick="markAttendance('${st.student_id}', 'ลา')">ลา</button>
          <button class="btn-tappable bg-red-600 text-white px-3 py-2 rounded" onclick="markAttendance('${st.student_id}', 'ขาด')">ขาด</button>
        </div>
      </div>
    `).join('');
  }

  // เพิ่มนักเรียน
  async function addStudent() {
    const num = studentNumberEl.value.trim();
    const name = studentNameEl.value.trim();
    const cls = studentClassEl.value.trim();
    if (!num || !name || !cls) return alert("กรุณากรอกข้อมูลให้ครบ");

    const { error } = await supabase.from('students').insert({
      student_id: crypto.randomUUID(),
      student_number: num,
      student_name: name,
      student_class: cls,
      timestamp: Date.now()
    });
    if (error) { alert("บันทึกไม่สำเร็จ"); console.error(error); }
    closeModal();
  }

  // เช็กชื่อ
  async function markAttendance(student_id, status) {
    const today = new Date().toISOString().split('T')[0];
    const { error } = await supabase.from('attendance').upsert({
      student_id,
      date: today,
      status,
      timestamp: Date.now()
    });
    if (error) { console.error(error); alert("เกิดข้อผิดพลาด"); }
  }

  // Modal
  document.getElementById('addStudentBtn').onclick = () => modal.classList.remove('hidden');
  function closeModal() {
    modal.classList.add('hidden');
    studentNumberEl.value = '';
    studentNameEl.value = '';
    studentClassEl.value = '';
  }

  // โหลดข้อมูลครั้งแรก + realtime
  loadStudents();
  supabase.channel('realtime-students')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, loadStudents)
    .subscribe();
  </script>
</body>
</html>
